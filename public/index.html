<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <title>Magic Story Colorbooks</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script>
Â  Â  tailwind.config = {
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  primary: "#ffbe57",
Â  Â  Â  Â  Â  Â  primaryDark: "#e0a645",
Â  Â  Â  Â  Â  Â  biscuit: "#fff7e6",
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  kids: ["Comic Sans MS", "Comic Neue", "Fredoka", "sans-serif"],
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };
Â  </script>

Â  <style>
Â  Â  body {
Â  Â  Â  background: #fff7e6;
Â  Â  Â  font-family: "Comic Neue", "Comic Sans MS", sans-serif;
Â  Â  }
Â  Â  .shelf-highlight {
Â  Â  Â  animation: shelfFlash 1.2s ease;
Â  Â  }
Â  Â  @keyframes shelfFlash {
Â  Â  Â  0% { background: #ffe9b8; }
Â  Â  Â  100% { background: transparent; }
Â  Â  }
Â  </style>
</head>

<body class="min-h-screen">

Â  Â  <header class="w-full bg-white shadow py-4 px-4 flex items-center justify-between border-b border-yellow-200">
Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  <img src="/Scribbles.jpg" class="w-10 h-10 rounded-full shadow" />
Â  Â  Â  <div>
Â  Â  Â  Â  <h1 class="text-xl font-bold text-yellow-800">Magic Story Colorbooks</h1>
Â  Â  Â  Â  <p class="text-xs text-yellow-700">
Â  Â  Â  Â  Â  Help your child's imagination grow with custom story coloring books.
Â  Â  Â  Â  </p>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <button class="px-3 py-1 rounded-full text-xs bg-yellow-200 border border-yellow-400">
Â  Â  Â  Parent dashboard (coming soon)
Â  Â  </button>
Â  </header>

Â  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-2 gap-8">

Â  Â  Â  Â  <section>
Â  Â  Â  <div class="bg-white rounded-2xl p-5 shadow border border-yellow-300">
Â  Â  Â  Â  <div class="flex gap-3 mb-4">
Â  Â  Â  Â  Â  <img src="/Scribbles.jpg" class="w-12 h-12 rounded-full shadow" />
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h2 class="font-bold text-yellow-800">Hi, Iâ€™m Scribbles!</h2>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-yellow-700">Tell me about your character and Iâ€™ll help make your story book.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <form id="book-form" class="space-y-4">

Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="font-semibold text-yellow-800 text-sm">Book title</label>
Â  Â  Â  Â  Â  Â  <input id="title"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Sammy the Brave Iguana" />
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="font-semibold text-yellow-800 text-sm">Main character</label>
Â  Â  Â  Â  Â  Â  <input id="main-character"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="An iguana named Sammy who's afraid of the dark" />
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="font-semibold text-yellow-800 text-sm">What should the story be about?</label>
Â  Â  Â  Â  Â  Â  <textarea id="story-idea"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rows="4"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Sammy hides under the covers until forest friends and fireflies help him feel brave."></textarea>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="font-semibold text-yellow-800 text-sm">Age range</label>
Â  Â  Â  Â  Â  Â  Â  <select id="age-range"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="3-5">3â€“5 years</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="5-7">5â€“7 years</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="7-9">7â€“9 years</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="font-semibold text-yellow-800 text-sm">Story length</label>
Â  Â  Â  Â  Â  Â  Â  <select id="page-count"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="8">8 pages</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="12">12 pages</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="16">16 pages</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <button id="generate-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full py-3 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow">
Â  Â  Â  Â  Â  Â  <span id="generate-btn-label">âœ¨ Generate Book (1 credit)</span>
Â  Â  Â  Â  Â  Â  <span id="generate-btn-spinner" class="hidden">Thinkingâ€¦</span>
Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  <button id="download-pdf-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  disabled
Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full py-3 rounded-xl bg-white text-yellow-700 border border-yellow-400 font-semibold disabled:opacity-40">
Â  Â  Â  Â  Â  Â  ğŸ“„ Unlock & Download PDF (5 credits total)
Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  <button id="generate-images-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  disabled
Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full py-3 rounded-xl bg-white text-yellow-700 border border-yellow-400 font-semibold disabled:opacity-40">
Â  Â  Â  Â  Â  Â  ğŸ¨ Generate Coloring Page Previews
Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  </form>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section>
Â  Â  Â  <div class="space-y-6">

Â  Â  Â  Â  Â  Â  Â  Â  <div id="status-bar"
Â  Â  Â  Â  Â  Â  Â class="rounded-xl bg-yellow-50 border border-yellow-200 p-4">
Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  <span id="status-icon">ğŸ“š</span>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <p id="status-title" class="font-bold text-yellow-900">Ready to create a book.</p>
Â  Â  Â  Â  Â  Â  Â  <p id="status-text" class="text-yellow-700 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Enter your idea and click â€œGenerate Bookâ€.
Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="story-card"
Â  Â  Â  Â  Â  Â  Â class="hidden bg-white rounded-2xl p-5 border border-yellow-300 shadow">
Â  Â  Â  Â  Â  <h3 id="story-title" class="text-xl font-bold text-yellow-900"></h3>
Â  Â  Â  Â  Â  <p id="story-tagline" class="text-sm text-yellow-700 mb-3"></p>
Â  Â  Â  Â  Â  <div id="story-body" class="space-y-3 text-yellow-900"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="prompts-card"
Â  Â  Â  Â  Â  Â  Â class="hidden bg-white rounded-2xl p-5 border border-yellow-300 shadow">
Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-yellow-900">Story pages</h3>
Â  Â  Â  Â  Â  <ol id="prompts-list" class="mt-2 space-y-3 text-yellow-900"></ol>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="images-card"
Â  Â  Â  Â  Â  Â  Â class="hidden bg-white rounded-2xl p-5 border border-yellow-300 shadow">
Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-yellow-900">Coloring page previews</h3>
Â  Â  Â  Â  Â  <p class="text-sm text-yellow-700 mb-2">Preview only</p>
Â  Â  Â  Â  Â  <div id="images-grid" class="grid grid-cols-2 gap-4"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  </div>
Â  Â  </section>
Â  </main>

<script>
Â  const form = document.getElementById("book-form");
Â  const generateBtn = document.getElementById("generate-btn");
Â  const generateBtnLabel = document.getElementById("generate-btn-label");
Â  const generateBtnSpinner = document.getElementById("generate-btn-spinner");
Â  const downloadBtn = document.getElementById("download-pdf-btn");
Â  const imagesBtn = document.getElementById("generate-images-btn");

Â  const statusIcon = document.getElementById("status-icon");
Â  const statusTitle = document.getElementById("status-title");
Â  const statusText = document.getElementById("status-text");

Â  const storyCard = document.getElementById("story-card");
Â  const storyTitleEl = document.getElementById("story-title");
Â  const storyTaglineEl = document.getElementById("story-tagline");
Â  const storyBodyEl = document.getElementById("story-body");

Â  const promptsCard = document.getElementById("prompts-card");
Â  const promptsList = document.getElementById("prompts-list");

Â  const imagesCard = document.getElementById("images-card");
Â  const imagesGrid = document.getElementById("images-grid");

Â  let lastBookData = null;

Â  function setStatus(obj) {
Â  Â  statusIcon.textContent = obj.icon;
Â  Â  statusTitle.textContent = obj.title;
Â  Â  statusText.textContent = obj.text;
Â  }

Â  function setLoading(isLoading) {
Â  Â  generateBtn.disabled = isLoading;
Â  Â  generateBtnSpinner.classList.toggle("hidden", !isLoading);
Â  Â  generateBtnLabel.textContent = isLoading ? "Generatingâ€¦" : "âœ¨ Generate Book (1 credit)";
Â  }

Â  function renderBook(data) {
Â  Â  storyTitleEl.textContent = data.title;
Â  Â  storyTaglineEl.textContent = data.tagline;

Â  Â  storyBodyEl.innerHTML = "";
Â  Â  data.paragraphs.forEach(p => {
Â  Â  Â  const el = document.createElement("p");
Â  Â  Â  el.textContent = p;
Â  Â  Â  storyBodyEl.appendChild(el);
Â  Â  });

Â  Â  promptsList.innerHTML = "";
Â  Â  data.prompts.forEach(item => {
Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  li.innerHTML = `<strong>Page ${item.page}:</strong> ${item.prompt}`;
Â  Â  Â  promptsList.appendChild(li);
Â  Â  });

Â  Â  storyCard.classList.remove("hidden");
Â  Â  promptsCard.classList.remove("hidden");

Â  Â  lastBookData = data;
Â  Â  downloadBtn.disabled = false;
Â  Â  imagesBtn.disabled = false;

Â  Â  setStatus({
Â  Â  Â  icon: "ğŸ“–",
Â  Â  Â  title: "Your storybook is ready!",
Â  Â  Â  text: "Now you can generate coloring pages or download the PDF."
Â  Â  });
Â  }

Â  form.addEventListener("submit", async (e) => {
Â  Â  e.preventDefault();

Â  Â  const title = document.getElementById("title").value;
Â  Â  const mainCharacter = document.getElementById("main-character").value;
Â  Â  const storyIdea = document.getElementById("story-idea").value;
Â  Â  const ageRange = document.getElementById("age-range").value;
Â  Â  const pageCount = document.getElementById("page-count").value;

Â  Â  setLoading(true);
Â  Â  setStatus({
Â  Â  Â  icon: "âœ¨",
Â  Â  Â  title: "Creating your storybookâ€¦",
Â  Â  Â  text: "Scribbles is writing a cozy story."
Â  Â  });

Â  Â  try {
Â  Â  Â  const res = await fetch("/api/generate-book", { // <-- CORRECTED: Changed to /api/generate-book
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  title,
Â  Â  Â  Â  Â  mainCharacter,
Â  Â  Â  Â  Â  storyIdea,
Â  Â  Â  Â  Â  ageRange,
Â  Â  Â  Â  Â  pageCount,
Â  Â  Â  Â  })
Â  Â  Â  });

Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  // Improved error handling for server errors (like 400 or 500)
Â  Â  Â  Â  const errorData = await res.json();
Â  Â  Â  Â  throw new Error(errorData.error || "Server responded with an error status.");
Â  Â  Â  }

Â  Â  Â  const data = await res.json();
Â  Â  Â  renderBook(data);

Â  Â  } catch (err) {
Â  Â  Â  console.error("Book Generation Error:", err);
Â  Â  Â  setStatus({
Â  Â  Â  Â  icon: "âŒ",
Â  Â  Â  Â  title: "Error",
Â  Â  Â  Â  text: err.message || "Could not generate your book."
Â  Â  Â  });
Â  Â  }

Â  Â  setLoading(false);
Â  });


Â  imagesBtn.addEventListener("click", async () => {
Â  Â  if (!lastBookData) return;

Â  Â  setStatus({
Â  Â  Â  icon: "ğŸ¨",
Â  Â  Â  title: "Making coloring pagesâ€¦",
Â  Â  Â  text: "Scribbles is drawing your line-art pages."
Â  Â  });

Â  Â  imagesBtn.disabled = true;

Â  Â  try {
        // Need to pass mainCharacter and title for image consistency
        const titleVal = document.getElementById("title").value || lastBookData.title || "";
        const mainCharacterVal = document.getElementById("main-character").value || "";
        
Â  Â  Â  const res = await fetch("/api/generate-images", {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({ 
            prompts: lastBookData.prompts,
            title: titleVal,
            mainCharacter: mainCharacterVal
        })
Â  Â  Â  });

Â  Â  Â  const raw = await res.json();
Â  Â  Â  console.log("Raw image payload:", raw);

Â  Â  Â  const normalized = (raw.images || raw.data || [])
Â  Â  Â  Â  .map((item, i) => {
Â  Â  Â  Â  Â  let url = item.url || item.image_url;

Â  Â  Â  Â  Â  if (!url && item.b64_json) {
Â  Â  Â  Â  Â  Â  url = `data:image/png;base64,${item.b64_json}`;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (!url) return null;

Â  Â  Â  Â  Â  return { page: item.page || i + 1, url };
Â  Â  Â  Â  })
Â  Â  Â  Â  .filter(Boolean);

Â  Â  Â  console.log("Normalized:", normalized);

Â  Â  Â  imagesGrid.innerHTML = "";
Â  Â  Â  normalized.forEach(img => {
Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  div.className = "border rounded-xl p-2 bg-yellow-50";
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <img src="${img.url}" class="w-full rounded mb-2 shadow" />
Â  Â  Â  Â  Â  <p class="text-center text-sm">Page ${img.page}</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  imagesGrid.appendChild(div);
Â  Â  Â  });

Â  Â  Â  imagesCard.classList.remove("hidden");

Â  Â  Â  setStatus({
Â  Â  Â  Â  icon: "ğŸ‰",
Â  Â  Â  Â  title: "Coloring pages ready!",
Â  Â  Â  Â  text: "Scroll down to see your preview pages."
Â  Â  Â  });

Â  Â  } catch (err) {
Â  Â  Â  console.error(err);
Â  Â  Â  setStatus({
Â  Â  Â  Â  icon: "âŒ",
Â  Â  Â  Â  title: "Image generation failed",
Â  Â  Â  Â  text: "Try again or check the server."
Â  Â  Â  });
Â  Â  }

Â  Â  imagesBtn.disabled = false;
Â  });
  
  
    downloadBtn.addEventListener("click", async () => {
    if (!lastBookData) return;

    setStatus({
        icon: "ğŸ“„",
        title: "Generating PDF...",
        text: "Your file is being prepared."
    });

    try {
        const res = await fetch("/api/export-pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // Send the entire book data to the PDF endpoint
            body: JSON.stringify(lastBookData),
        });

        if (!res.ok) {
            throw new Error("Failed to create PDF file on the server.");
        }

        // The response is a file stream (PDF), so we treat it as a blob
        const blob = await res.blob();
        
        // Use the file saver trick to trigger a download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Use the book title to name the file
        const filename = (lastBookData.title || "custom_storybook").replace(/[^a-z0-9\-]/gi, "_").toLowerCase() + ".pdf";
        a.download = filename;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);


        setStatus({
            icon: "ğŸ‰",
            title: "PDF Downloaded!",
            text: "Check your downloads folder for the PDF."
        });

    } catch (err) {
        console.error("PDF Export Error:", err);
        setStatus({
            icon: "âŒ",
            title: "PDF Export Failed",
            text: err.message || "Could not generate or download the PDF."
        });
    }
});
</script>

</body>
</html>
