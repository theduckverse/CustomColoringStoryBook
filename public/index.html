<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Story Colorbooks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#ffbe57",
            primaryDark: "#e0a645",
            biscuit: "#fff7e6",
          },
          fontFamily: {
            kids: ["Comic Sans MS", "Comic Neue", "Fredoka", "sans-serif"],
          }
        }
      }
    };
  </script>

  <style>
    body {
      background: #fff7e6;
      font-family: "Comic Neue", "Comic Sans MS", sans-serif;
    }
    .shelf-highlight {
      animation: shelfFlash 1.2s ease;
    }
    @keyframes shelfFlash {
      0% { background: #ffe9b8; }
      100% { background: transparent; }
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- HEADER -->
  <header class="w-full bg-white shadow py-4 px-4 flex items-center justify-between border-b border-yellow-200">
    <div class="flex items-center gap-3">
      <img src="/Scribbles.jpg" class="w-10 h-10 rounded-full shadow" />
      <div>
        <h1 class="text-xl font-bold text-yellow-800">Magic Story Colorbooks</h1>
        <p class="text-xs text-yellow-700">
          Help your child's imagination grow with custom story coloring books.
        </p>
      </div>
    </div>
    <button class="px-3 py-1 rounded-full text-xs bg-yellow-200 border border-yellow-400">
      Parent dashboard (coming soon)
    </button>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- LEFT: FORM -->
    <section>
      <div class="bg-white rounded-2xl p-5 shadow border border-yellow-300">
        <div class="flex gap-3 mb-4">
          <img src="/Scribbles.jpg" class="w-12 h-12 rounded-full shadow" />
          <div>
            <h2 class="font-bold text-yellow-800">Hi, I‚Äôm Scribbles!</h2>
            <p class="text-sm text-yellow-700">Tell me about your character and I‚Äôll help make your story book.</p>
          </div>
        </div>

        <form id="book-form" class="space-y-4">

          <div>
            <label class="font-semibold text-yellow-800 text-sm">Book title</label>
            <input id="title"
                   class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50"
                   placeholder="Sammy the Brave Iguana" />
          </div>

          <div>
            <label class="font-semibold text-yellow-800 text-sm">Main character</label>
            <input id="main-character"
                   class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50"
                   placeholder="An iguana named Sammy who's afraid of the dark" />
          </div>

          <div>
            <label class="font-semibold text-yellow-800 text-sm">What should the story be about?</label>
            <textarea id="story-idea"
                      rows="4"
                      class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50"
                      placeholder="Sammy hides under the covers until forest friends and fireflies help him feel brave."></textarea>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="font-semibold text-yellow-800 text-sm">Age range</label>
              <select id="age-range"
                      class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50">
                <option value="3-5">3‚Äì5 years</option>
                <option value="5-7">5‚Äì7 years</option>
                <option value="7-9">7‚Äì9 years</option>
              </select>
            </div>

            <div>
              <label class="font-semibold text-yellow-800 text-sm">Story length</label>
              <select id="page-count"
                      class="w-full px-3 py-2 rounded-xl border border-yellow-300 bg-yellow-50">
                <option value="8">8 pages</option>
                <option value="12">12 pages</option>
                <option value="16">16 pages</option>
              </select>
            </div>
          </div>

          <button id="generate-btn"
                  class="w-full py-3 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow">
            <span id="generate-btn-label">‚ú® Generate Book (1 credit)</span>
            <span id="generate-btn-spinner" class="hidden">Thinking‚Ä¶</span>
          </button>

          <button id="download-pdf-btn"
                  disabled
                  class="w-full py-3 rounded-xl bg-white text-yellow-700 border border-yellow-400 font-semibold disabled:opacity-40">
            üìÑ Unlock & Download PDF (5 credits total)
          </button>

          <button id="generate-images-btn"
                  disabled
                  class="w-full py-3 rounded-xl bg-white text-yellow-700 border border-yellow-400 font-semibold disabled:opacity-40">
            üé® Generate Coloring Page Previews
          </button>

        </form>
      </div>
    </section>

    <!-- RIGHT: OUTPUT -->
    <section>
      <div class="space-y-6">

        <!-- STATUS BAR -->
        <div id="status-bar"
             class="rounded-xl bg-yellow-50 border border-yellow-200 p-4">
          <div class="flex gap-2">
            <span id="status-icon">üìö</span>
            <div>
              <p id="status-title" class="font-bold text-yellow-900">Ready to create a book.</p>
              <p id="status-text" class="text-yellow-700 text-sm">
                Enter your idea and click ‚ÄúGenerate Book‚Äù.
              </p>
            </div>
          </div>
        </div>

        <!-- STORY CARD -->
        <div id="story-card"
             class="hidden bg-white rounded-2xl p-5 border border-yellow-300 shadow">
          <h3 id="story-title" class="text-xl font-bold text-yellow-900"></h3>
          <p id="story-tagline" class="text-sm text-yellow-700 mb-3"></p>
          <div id="story-body" class="space-y-3 text-yellow-900"></div>
        </div>

        <!-- PAGE PROMPTS -->
        <div id="prompts-card"
             class="hidden bg-white rounded-2xl p-5 border border-yellow-300 shadow">
          <h3 class="text-xl font-bold text-yellow-900">Story pages</h3>
          <ol id="prompts-list" class="mt-2 space-y-3 text-yellow-900"></ol>
        </div>

        <!-- COLORING IMAGES -->
        <div id="images-card"
             class="hidden bg-white rounded-2xl p-5 border border-yellow-300 shadow">
          <h3 class="text-xl font-bold text-yellow-900">Coloring page previews</h3>
          <p class="text-sm text-yellow-700 mb-2">Preview only</p>
          <div id="images-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

      </div>
    </section>
  </main>

<!-- ======================
     JAVASCRIPT
====================== -->
<script>
  const form = document.getElementById("book-form");
  const generateBtn = document.getElementById("generate-btn");
  const generateBtnLabel = document.getElementById("generate-btn-label");
  const generateBtnSpinner = document.getElementById("generate-btn-spinner");
  const downloadBtn = document.getElementById("download-pdf-btn");
  const imagesBtn = document.getElementById("generate-images-btn");

  const statusIcon = document.getElementById("status-icon");
  const statusTitle = document.getElementById("status-title");
  const statusText = document.getElementById("status-text");

  const storyCard = document.getElementById("story-card");
  const storyTitleEl = document.getElementById("story-title");
  const storyTaglineEl = document.getElementById("story-tagline");
  const storyBodyEl = document.getElementById("story-body");

  const promptsCard = document.getElementById("prompts-card");
  const promptsList = document.getElementById("prompts-list");

  const imagesCard = document.getElementById("images-card");
  const imagesGrid = document.getElementById("images-grid");

  let lastBookData = null;

  function setStatus(obj) {
    statusIcon.textContent = obj.icon;
    statusTitle.textContent = obj.title;
    statusText.textContent = obj.text;
  }

  function setLoading(isLoading) {
    generateBtn.disabled = isLoading;
    generateBtnSpinner.classList.toggle("hidden", !isLoading);
    generateBtnLabel.textContent = isLoading ? "Generating‚Ä¶" : "‚ú® Generate Book (1 credit)";
  }

  function renderBook(data) {
    storyTitleEl.textContent = data.title;
    storyTaglineEl.textContent = data.tagline;

    storyBodyEl.innerHTML = "";
    data.paragraphs.forEach(p => {
      const el = document.createElement("p");
      el.textContent = p;
      storyBodyEl.appendChild(el);
    });

    promptsList.innerHTML = "";
    data.prompts.forEach(item => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>Page ${item.page}:</strong> ${item.prompt}`;
      promptsList.appendChild(li);
    });

    storyCard.classList.remove("hidden");
    promptsCard.classList.remove("hidden");

    lastBookData = data;
    downloadBtn.disabled = false;
    imagesBtn.disabled = false;

    setStatus({
      icon: "üìñ",
      title: "Your storybook is ready!",
      text: "Now you can generate coloring pages or download the PDF."
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value;
    const mainCharacter = document.getElementById("main-character").value;
    const storyIdea = document.getElementById("story-idea").value;
    const ageRange = document.getElementById("age-range").value;
    const pageCount = document.getElementById("page-count").value;

    setLoading(true);
    setStatus({
      icon: "‚ú®",
      title: "Creating your storybook‚Ä¶",
      text: "Scribbles is writing a cozy story."
    });

    try {
   const titleVal = document.getElementById("title").value || lastBookData.title || "";
const mainCharacterVal = document.getElementById("main-character").value || "";

const res = await fetch("/api/generate-images", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    prompts: lastBookData.prompts,
    title: titleVal,
    mainCharacter: mainCharacterVal
  })
});

      const data = await res.json();
      renderBook(data);

    } catch (err) {
      setStatus({ icon: "‚ùå", title: "Error", text: "Could not generate your book." });
    }

    setLoading(false);
  });

  imagesBtn.addEventListener("click", async () => {
    if (!lastBookData) return;

    setStatus({
      icon: "üé®",
      title: "Making coloring pages‚Ä¶",
      text: "Scribbles is drawing your line-art pages."
    });

    imagesBtn.disabled = true;

    try {
      const res = await fetch("/api/generate-images", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompts: lastBookData.prompts })
      });

      const raw = await res.json();
      console.log("Raw image payload:", raw);

      const normalized = (raw.images || raw.data || [])
        .map((item, i) => {
          let url = item.url || item.image_url;

          if (!url && item.b64_json) {
            url = `data:image/png;base64,${item.b64_json}`;
          }

          if (!url) return null;

          return { page: item.page || i + 1, url };
        })
        .filter(Boolean);

      console.log("Normalized:", normalized);

      imagesGrid.innerHTML = "";
      normalized.forEach(img => {
        const div = document.createElement("div");
        div.className = "border rounded-xl p-2 bg-yellow-50";
        div.innerHTML = `
          <img src="${img.url}" class="w-full rounded mb-2 shadow" />
          <p class="text-center text-sm">Page ${img.page}</p>
        `;
        imagesGrid.appendChild(div);
      });

      imagesCard.classList.remove("hidden");

      setStatus({
        icon: "üéâ",
        title: "Coloring pages ready!",
        text: "Scroll down to see your preview pages."
      });

    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Image generation failed",
        text: "Try again or check the server."
      });
    }

    imagesBtn.disabled = false;
  });
</script>

</body>
</html>
