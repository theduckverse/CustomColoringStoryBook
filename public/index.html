<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Story Colorbooks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            biscuit: "#FFF7E6",
            amberSoft: "#FEF3C7",
          },
          fontFamily: {
            kids: ["Comic Neue", "Comic Sans MS", "system-ui", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    body {
      background: #fff7e6;
      font-family: "Comic Neue", "Comic Sans MS", system-ui, sans-serif;
    }

    .shelf-highlight {
      animation: shelfFlash 1.2s ease;
    }

    @keyframes shelfFlash {
      0% {
        box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.9);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
      }
    }
  </style>
</head>

<body class="min-h-screen text-amber-900">

  <!-- NAVBAR -->
  <header class="w-full bg-white border-b border-amber-100 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="/Scribbles.jpg" alt="Scribbles" class="w-10 h-10 rounded-full shadow" />
        <div>
          <h1 class="text-lg font-bold text-amber-900">Magic Story Colorbooks</h1>
          <p class="text-xs text-amber-700">
            Turn your child‚Äôs ideas into cozy story coloring books.
          </p>
        </div>
      </div>

      <nav class="flex items-center gap-2 text-xs">
        <button id="nav-home" class="px-3 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200">
          Home
        </button>
        <button id="nav-reading" class="px-3 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200">
          Get reading
        </button>
        <button id="nav-make" class="px-3 py-1 rounded-full bg-amber-100 text-amber-900 border border-amber-300 font-semibold">
          Make a book
        </button>
        <button id="nav-fun" class="px-3 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200">
          Fun ideas
        </button>
        <button id="nav-shelf" class="px-3 py-1 rounded-full bg-amber-50 text-amber-800 border border-amber-200">
          My shelf
        </button>

        <span id="credits-pill"
              class="ml-2 px-3 py-1 rounded-full bg-amber-500 text-white font-semibold shadow">
          Crayon Credits: 0
        </span>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-10">

    <!-- STATUS BAR -->
    <section class="w-full">
      <div id="status-bar"
           class="rounded-xl bg-amber-50 border border-amber-100 px-4 py-3 flex gap-3 items-start">
        <div id="status-icon" class="text-xl">üìñ</div>
        <div>
          <p id="status-title" class="text-sm font-bold text-amber-900">
            Ready to create a book.
          </p>
          <p id="status-text" class="text-xs text-amber-700">
            Tell Scribbles about your character and what the story should be about, then click ‚ÄúGenerate Book‚Äù.
          </p>
        </div>
      </div>
    </section>

    <!-- MAKE A BOOK SECTION -->
    <section id="make-book-section" class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
      <!-- LEFT: FORM -->
      <div class="bg-white rounded-2xl shadow border border-amber-200 p-5">
        <div class="flex gap-3 mb-4">
          <img src="/Scribbles.jpg" alt="Scribbles" class="w-12 h-12 rounded-full shadow" />
          <div>
            <h2 class="font-bold text-amber-900">Hi, I‚Äôm Scribbles!</h2>
            <p class="text-xs text-amber-700">
              Tell me about your character and I‚Äôll help you make a story coloring book for the shelf.
            </p>
          </div>
        </div>

        <form id="book-form" class="space-y-4">
          <div>
            <label class="block text-xs font-semibold text-amber-800 mb-1">
              Book title <span class="text-amber-500">(optional)</span>
            </label>
            <input id="title"
                   type="text"
                   class="w-full px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-sm"
                   placeholder="Sammy the Brave Iguana" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-amber-800 mb-1">
              Main character
            </label>
            <input id="main-character"
                   type="text"
                   class="w-full px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-sm"
                   placeholder="An iguana named Sammy who's afraid of the dark" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-amber-800 mb-1">
              What should the story be about?
            </label>
            <textarea id="story-idea"
                      rows="4"
                      class="w-full px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-sm"
                      placeholder="Sammy hides under the covers until forest friends and fireflies help him feel brave."></textarea>
            <p class="mt-1 text-[11px] text-amber-600">
              The app turns this into a cozy kids‚Äô story with matching coloring pages laid out like a real book.
            </p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-amber-800 mb-1">
                Age range
              </label>
              <select id="age-range"
                      class="w-full px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-sm">
                <option value="3-5">3‚Äì5 years</option>
                <option value="5-7">5‚Äì7 years</option>
                <option value="7-9">7‚Äì9 years</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-semibold text-amber-800 mb-1">
                Story length
              </label>
              <select id="page-count"
                      class="w-full px-3 py-2 rounded-xl border border-amber-200 bg-amber-50 text-sm">
                <option value="8">8 pages</option>
                <option value="12">12 pages</option>
                <option value="16">16 pages</option>
              </select>
            </div>
          </div>

          <button id="generate-btn"
                  type="submit"
                  class="w-full py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white text-sm font-bold shadow flex items-center justify-center gap-2">
            <span id="generate-btn-label">‚ú® Generate Book (1 credit)</span>
            <span id="generate-btn-spinner" class="hidden text-xs">
              Thinking‚Ä¶
            </span>
          </button>

          <button id="download-pdf-btn"
                  type="button"
                  disabled
                  class="w-full py-3 rounded-xl bg-white text-amber-800 border border-amber-300 text-sm font-semibold disabled:opacity-40">
            üìÑ Unlock & Download PDF (5 credits total)
          </button>

          <button id="generate-images-btn"
                  type="button"
                  disabled
                  class="w-full py-3 rounded-xl bg-white text-amber-800 border border-amber-300 text-sm font-semibold disabled:opacity-40">
            üé® Generate Coloring Page Previews
          </button>

          <p class="text-[11px] text-amber-600 mt-1">
            Making a new story book uses 1 Crayon Credit. Unlocking downloads for that book uses 4 more credits (5 total).
          </p>
        </form>
      </div>

      <!-- RIGHT: STORY CARD -->
      <div class="space-y-4">
        <div id="story-card"
             class="hidden bg-white rounded-2xl shadow border border-amber-200 p-5">
          <div class="flex items-center justify-between mb-2 text-xs text-amber-600">
            <span class="uppercase tracking-[0.14em]">Story book</span>
            <span class="px-2 py-0.5 rounded-full bg-amber-50 border border-amber-100">
              AI made
            </span>
          </div>
          <h3 id="story-title" class="text-lg font-bold text-amber-900 mb-1"></h3>
          <p id="story-tagline" class="text-xs text-amber-700 mb-3"></p>
          <div id="story-body" class="space-y-2 text-sm leading-relaxed"></div>
        </div>

        <!-- placeholder when no story yet -->
        <div id="story-card-empty"
             class="bg-white rounded-2xl shadow border border-amber-100 p-5 text-sm text-amber-800">
          <p class="font-semibold mb-1">No story yet.</p>
          <p class="text-xs text-amber-700">
            Once Scribbles writes your story, it will appear here with all the text together like a regular picture book.
          </p>
        </div>
      </div>
    </section>

    <!-- SHELF SECTION -->
    <section id="shelf-section" class="space-y-6">
      <!-- TOP SHELF PAGES -->
      <div id="pages-top-card"
           class="hidden bg-white rounded-2xl shadow border border-amber-200 p-5 relative overflow-hidden">
        <div class="flex items-center justify-between mb-2 text-xs text-amber-600">
          <span class="uppercase tracking-[0.14em]">Story pages</span>
          <span class="rounded-full border border-amber-100 px-2 py-0.5 text-[11px]">
            Pages 1+
          </span>
        </div>
        <p class="text-xs text-amber-700 mb-3">
          Each card shows the picture idea at the top and the story words for that page at the bottom, like a little book laid out on a shelf.
        </p>

        <div id="pages-grid-top" class="grid sm:grid-cols-2 gap-3 relative z-10"></div>

        <!-- visual shelf bar -->
        <div class="absolute left-0 right-0 bottom-0 h-2 bg-amber-500"></div>
      </div>

      <!-- BOTTOM SHELF PAGES -->
      <div id="pages-bottom-card"
           class="hidden bg-white rounded-2xl shadow border border-amber-200 p-5 relative overflow-hidden">
        <div class="flex items-center justify-between mb-2 text-xs text-amber-600">
          <span class="uppercase tracking-[0.14em]">More pages</span>
          <span class="rounded-full border border-amber-100 px-2 py-0.5 text-[11px]">
            Pages 5+
          </span>
        </div>
        <p class="text-xs text-amber-700 mb-3">
          If your story is longer, the rest of the pages sit neatly on this second shelf.
        </p>

        <div id="pages-grid-bottom" class="grid sm:grid-cols-2 gap-3 relative z-10"></div>

        <!-- visual shelf bar -->
        <div class="absolute left-0 right-0 bottom-0 h-2 bg-amber-500"></div>
      </div>

      <!-- COLORING IMAGE PREVIEWS -->
      <div id="images-card"
           class="hidden bg-white rounded-2xl shadow border border-amber-200 p-5">
        <div class="flex items-center justify-between mb-2 text-xs text-amber-600">
          <span class="uppercase tracking-[0.14em]">Coloring pages</span>
          <span class="rounded-full border border-amber-100 px-2 py-0.5 text-[11px]">
            Preview only
          </span>
        </div>
        <p class="text-xs text-amber-700 mb-3">
          These are AI line-art previews based on your story prompts. Once unlocked, you can print them or use them in drawing apps.
        </p>

        <div id="images-grid" class="grid sm:grid-cols-2 gap-4"></div>
      </div>
    </section>
  </main>

  <!-- =================== SCRIPT =================== -->
  <script>
  // =================== CREDIT SYSTEM ===================
  let credits = 0;
  let downloadsUnlockedForCurrentBook = false;

  const CREDITS_KEY = "scribbles_credits";

  function loadCredits() {
    const stored = localStorage.getItem(CREDITS_KEY);
    if (stored !== null) {
      const n = parseInt(stored, 10);
      credits = Number.isNaN(n) ? 0 : Math.max(0, n);
    } else {
      // Starter credits for new users (for testing)
      credits = 10;
      localStorage.setItem(CREDITS_KEY, String(credits));
    }
  }

  function saveCredits() {
    localStorage.setItem(CREDITS_KEY, String(credits));
  }

  function updateCreditsDisplay() {
    const pill = document.getElementById("credits-pill");
    if (pill) {
      pill.textContent = `Crayon Credits: ${credits}`;
    }
  }

  // =================== DOM ELEMENTS ===================
  const form = document.getElementById("book-form");
  const generateBtn = document.getElementById("generate-btn");
  const generateBtnLabel = document.getElementById("generate-btn-label");
  const generateBtnSpinner = document.getElementById("generate-btn-spinner");
  const downloadBtn = document.getElementById("download-pdf-btn");
  const imagesBtn = document.getElementById("generate-images-btn");

  const statusIcon = document.getElementById("status-icon");
  const statusTitle = document.getElementById("status-title");
  const statusText = document.getElementById("status-text");

  const storyCard = document.getElementById("story-card");
  const storyCardEmpty = document.getElementById("story-card-empty");
  const storyTitleEl = document.getElementById("story-title");
  const storyTaglineEl = document.getElementById("story-tagline");
  const storyBodyEl = document.getElementById("story-body");

  const pagesTopCard = document.getElementById("pages-top-card");
  const pagesBottomCard = document.getElementById("pages-bottom-card");
  const pagesGridTop = document.getElementById("pages-grid-top");
  const pagesGridBottom = document.getElementById("pages-grid-bottom");

  const imagesCard = document.getElementById("images-card");
  const imagesGrid = document.getElementById("images-grid");

  let lastBookData = null;
  let lastFormInputs = {
    title: "",
    mainCharacter: "",
    storyIdea: "",
    ageRange: "",
    pageCount: ""
  };

  // =================== STATUS + LOADING ===================
  function setLoading(isLoading, labelWhenReady = "‚ú® Generate Book (1 credit)") {
    generateBtn.disabled = isLoading;
    generateBtnSpinner.classList.toggle("hidden", !isLoading);
    generateBtnLabel.textContent = isLoading ? "Generating..." : labelWhenReady;

    if (isLoading) {
      statusIcon.classList.add("animate-spin");
    } else {
      statusIcon.classList.remove("animate-spin");
    }
  }

  function setStatus({ icon, title, text }) {
    statusIcon.textContent = icon;
    statusTitle.textContent = title;
    statusText.textContent = text;
  }

  // =================== RENDER FUNCTIONS ===================
  function renderBook(data) {
    const { title, tagline, paragraphs, prompts, ageRange } = data;

    // Clear old images when a new book is made
    imagesGrid.innerHTML = "";
    imagesCard.classList.add("hidden");

    // --- Story "overview" card at the top shelf ---
    storyTitleEl.textContent = title || "Your Custom Story";
    storyTaglineEl.textContent =
      tagline || (ageRange ? `For ages ${ageRange}` : "");
    storyBodyEl.innerHTML = "";
    (paragraphs || []).forEach((p) => {
      const para = document.createElement("p");
      para.className = "text-amber-900";
      para.textContent = p;
      storyBodyEl.appendChild(para);
    });
    storyCard.classList.remove("hidden");
    storyCardEmpty.classList.add("hidden");

    // --- Build page cards: prompt on top, story snippet on bottom ---
    pagesGridTop.innerHTML = "";
    pagesGridBottom.innerHTML = "";

    const allPrompts = Array.isArray(prompts) ? prompts : [];
    const totalPages = allPrompts.length;
    const half = Math.ceil(totalPages / 2);

    const topPages = allPrompts.slice(0, half);
    const bottomPages = allPrompts.slice(half);

    // Turn all paragraphs into a list of sentences
    const sentenceSource = (paragraphs || []).join(" ");
    const sentences = sentenceSource
      .split(/(?<=[.!?])\s+/)
      .filter((s) => s.trim().length > 0);

    function createPageCard(item, index) {
      const pageNumber = item.page || index + 1;
      const snippet =
        sentences[index] ||
        sentences[sentences.length - 1] ||
        "";

      const card = document.createElement("div");
      card.className =
        "bg-[#FFFBEB] rounded-xl border border-amber-200 p-3 flex flex-col gap-2";

      const pageLabel = document.createElement("p");
      pageLabel.className =
        "text-[11px] uppercase tracking-[0.12em] text-amber-700";
      pageLabel.textContent = `Page ${pageNumber}`;

      const promptEl = document.createElement("p");
      promptEl.className = "text-xs text-amber-800 font-semibold";
      promptEl.textContent = item.prompt;

      const storySnippetEl = document.createElement("p");
      storySnippetEl.className = "text-sm text-amber-900";
      storySnippetEl.textContent = snippet;

      card.appendChild(pageLabel);
      card.appendChild(promptEl);
      card.appendChild(storySnippetEl);

      return card;
    }

    topPages.forEach((item, index) => {
      const card = createPageCard(item, index);
      pagesGridTop.appendChild(card);
    });

    bottomPages.forEach((item, index) => {
      const card = createPageCard(item, half + index);
      pagesGridBottom.appendChild(card);
    });

    if (topPages.length > 0) {
      pagesTopCard.classList.remove("hidden");
    } else {
      pagesTopCard.classList.add("hidden");
    }

    if (bottomPages.length > 0) {
      pagesBottomCard.classList.remove("hidden");
    } else {
      pagesBottomCard.classList.add("hidden");
    }

    setStatus({
      icon: "‚úÖ",
      title: "Book generated.",
      text: "Your story is now laid out page by page on the shelves, with picture ideas on top and words on the bottom like a real kids‚Äô book.",
    });

    lastBookData = data;
    downloadBtn.disabled = false;
    downloadsUnlockedForCurrentBook = false;

    // Enable image previews button if we have prompts
    imagesBtn.disabled = !(allPrompts.length > 0);
  }

  function renderImages(images) {
    imagesGrid.innerHTML = "";
    images.forEach((img) => {
      const wrapper = document.createElement("figure");
      wrapper.className =
        "bg-[#FFFBEB] rounded-xl border border-amber-200 overflow-hidden flex flex-col";

      const imageEl = document.createElement("img");
      imageEl.src = img.url;
      imageEl.alt = `Coloring page ${img.page}`;
      imageEl.className = "w-full h-auto block";

      const caption = document.createElement("figcaption");
      caption.className = "text-xs text-amber-800 px-3 py-2";
      caption.textContent = `Page ${img.page}`;

      wrapper.appendChild(imageEl);
      wrapper.appendChild(caption);
      imagesGrid.appendChild(wrapper);
    });

    if (images.length > 0) {
      imagesCard.classList.remove("hidden");
    }

    setStatus({
      icon: "üñçÔ∏è",
      title: "Coloring page previews ready.",
      text: "These are AI line-art pages based on your story prompts. Unlock downloads to save or print them."
    });
  }

  // =================== INITIALIZE CREDITS ===================
  loadCredits();
  updateCreditsDisplay();

  // =================== FORM SUBMIT: GENERATE BOOK (1 CREDIT) ===================
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value;
    const mainCharacter = document.getElementById("main-character").value;
    const storyIdea = document.getElementById("story-idea").value;
    const ageRange = document.getElementById("age-range").value;
    const pageCount = document.getElementById("page-count").value;

    // remember inputs for image prompts
    lastFormInputs = { title, mainCharacter, storyIdea, ageRange, pageCount };

    if (!mainCharacter.trim() && !storyIdea.trim()) {
      setStatus({
        icon: "‚ö†Ô∏è",
        title: "Tell Scribbles a bit more!",
        text: "Add a main character, a feeling, or a problem you want the story to be about."
      });
      return;
    }

    // Check credits before generating
    if (credits < 1) {
      setStatus({
        icon: "üí≥",
        title: "Not enough Crayon Credits.",
        text: "Scribbles needs at least 1 Crayon Credit to write a new story. A grown-up can add more credits in the future."
      });
      return;
    }

    // Spend 1 credit
    credits -= 1;
    saveCredits();
    updateCreditsDisplay();

    setLoading(true);
    downloadBtn.disabled = true;
    imagesBtn.disabled = true;
    lastBookData = null;
    downloadsUnlockedForCurrentBook = false;

    setStatus({
      icon: "‚ú®",
      title: "Scribbles is writing your magic story‚Ä¶",
      text: "Your crayon helper is asking the AI to write a cosy story with page-by-page layout for the shelves."
    });

    try {
      const res = await fetch("/api/generate-book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, mainCharacter, storyIdea, ageRange, pageCount })
      });

      if (!res.ok) {
        throw new Error("Request failed");
      }

      const data = await res.json();
      renderBook(data);
    } catch (err) {
      console.error(err);
      // Refund the credit if it truly failed
      credits += 1;
      saveCredits();
      updateCreditsDisplay();

      setStatus({
        icon: "‚ùå",
        title: "Something went wrong.",
        text: "Scribbles couldn't finish your story. Please try again in a moment."
      });
    } finally {
      setLoading(false);
    }
  });

  // =================== DOWNLOAD PDF (UNLOCKS AT 5 CREDITS TOTAL) ===================
  downloadBtn.addEventListener("click", async () => {
    if (!lastBookData) return;

    // If downloads not unlocked yet, try to spend 4 more credits
    if (!downloadsUnlockedForCurrentBook) {
      if (credits < 4) {
        setStatus({
          icon: "üí≥",
          title: "Not enough credits to unlock downloads.",
          text: "You need 4 more Crayon Credits to unlock printing and full downloads for this book (5 total including the story)."
        });
        return;
      }

      credits -= 4;
      saveCredits();
      updateCreditsDisplay();
      downloadsUnlockedForCurrentBook = true;

      setStatus({
        icon: "üîì",
        title: "Downloads unlocked!",
        text: "You can now download and print this story anytime. The book stays on your shelf."
      });
    }

    // Now perform the real PDF download
    try {
      const res = await fetch("/api/export-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastBookData)
      });

      if (!res.ok) throw new Error("PDF request failed");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = (lastBookData.title || "custom-story") + ".pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "PDF download failed.",
        text: "Something went wrong while creating the PDF. Try again later."
      });
    }
  });

  // =================== GENERATE IMAGES (PREVIEW ONLY) ===================
  imagesBtn.addEventListener("click", async () => {
    if (!lastBookData || !Array.isArray(lastBookData.prompts)) return;

    setStatus({
      icon: "üé®",
      title: "Making coloring pages‚Ä¶",
      text: "Scribbles is drawing your line-art pages.",
    });

    imagesBtn.disabled = true;

    try {
      const title =
        lastBookData.title ||
        lastFormInputs.title ||
        "Children's story book";

      const storyIdea = (lastFormInputs.storyIdea || "").trim();

      const mcRaw = (
        lastFormInputs.mainCharacter ||
        lastBookData.mainCharacter ||
        ""
      ).trim();

      const characterDescription =
        mcRaw && mcRaw.length
          ? `${mcRaw}. Draw the SAME main character on every page: same face or animal features, same hairstyle/fur/markings, same approximate age/size, and the same simple outfit or body pattern.`
          : `a friendly storybook character. Draw the SAME main character on every page: same features, same approximate age/size, and the same simple outfit.`;

      const promptStrings = lastBookData.prompts.map((item, index) => {
        const pageNumber = item.page || index + 1;
        const baseScene =
          item.prompt ||
          item.description ||
          (typeof item === "string" ? item : "") ||
          `Scene ${pageNumber}`;

        const sceneText = baseScene.replace(/\s+/g, " ").trim().slice(0, 500);

        const contextLine = storyIdea
          ? `Story idea: ${storyIdea}. `
          : "";

        return (
          `Black-and-white line-art coloring page for a children's story titled "${title}". ` +
          contextLine +
          `This image must match PAGE ${pageNumber} of the story. ` +
          `Scene to draw (illustrate this exact moment): ${sceneText}. ` +
          `Cartoon style, cozy picture-book vibe, kid-friendly, big simple shapes, thick clean outlines, white background, no color or shading, no grey shading, no gradients.`
        );
      });

      console.log("Prompt strings sent to /api/generate-images:", promptStrings);

      const res = await fetch("/api/generate-images", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompts: promptStrings,
          character: characterDescription
        }),
      });

      if (!res.ok) {
        throw new Error("Bad response from /api/generate-images");
      }

      const raw = await res.json();
      console.log("Raw image payload:", raw);

      const normalized = (raw.images || raw.data || [])
        .map((item, i) => {
          let url = item.url || item.image_url;
          if (!url && item.b64_json) {
            url = `data:image/png;base64,${item.b64_json}`;
          }
          if (!url) return null;
          return { page: item.page || i + 1, url };
        })
        .filter(Boolean);

      renderImages(normalized);

      if (normalized.length > 0) {
        setStatus({
          icon: "üéâ",
          title: "Coloring pages ready!",
          text: "Scroll down to see your preview pages.",
        });
      } else {
        setStatus({
          icon: "‚ö†Ô∏è",
          title: "No images received",
          text: "The image API did not return any images. Check the server logs.",
        });
      }
    } catch (err) {
      console.error("Image generation error:", err);
      setStatus({
        icon: "‚ùå",
        title: "Image generation failed",
        text: "Try again or check the server.",
      });
    }

    imagesBtn.disabled = false;
  });

  // =================== NAV BUTTON BEHAVIOR ===================
  const navHome = document.getElementById("nav-home");
  const navReading = document.getElementById("nav-reading");
  const navMake = document.getElementById("nav-make");
  const navFun = document.getElementById("nav-fun");
  const navShelf = document.getElementById("nav-shelf");
  const makeBookSection = document.getElementById("make-book-section");
  const shelfSection = document.getElementById("shelf-section");

  function smoothScrollTo(el) {
    if (!el) return;
    el.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  if (navHome) {
    navHome.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
      setStatus({
        icon: "üè†",
        title: "Back to the beginning.",
        text: "Scribbles is ready whenever you want to make another book."
      });
    });
  }

  if (navMake) {
    navMake.addEventListener("click", () => {
      smoothScrollTo(makeBookSection);
      setStatus({
        icon: "‚úèÔ∏è",
        title: "Let‚Äôs make a new book!",
        text: "Tell Scribbles about your character and what kind of adventure they go on."
      });
    });
  }

  if (navReading || navShelf) {
    const goToShelf = () => {
      smoothScrollTo(shelfSection);
      if (shelfSection) {
        shelfSection.classList.add("shelf-highlight");
        setTimeout(() => {
          shelfSection.classList.remove("shelf-highlight");
        }, 1200);
      }
      setStatus({
        icon: "üìö",
        title: "Your shelf of stories.",
        text: "New stories, layouts, and coloring previews appear here once Scribbles makes them."
      });
    };

    if (navReading) navReading.addEventListener("click", goToShelf);
    if (navShelf) navShelf.addEventListener("click", goToShelf);
  }

  if (navFun) {
    navFun.addEventListener("click", () => {
      setStatus({
        icon: "üé≤",
        title: "Fun ideas coming soon!",
        text: "Scribbles is planning extra activities, drawing prompts, and games to go with your books."
      });
    });
  }
  </script>
</body>
</html>
