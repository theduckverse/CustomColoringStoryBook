<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Story Colorbooks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: "#4DA3FF",       /* soft kids-blue */
        primaryDark: "#1E88E5",
        bgLight: "#F0F8FF",
        card: "#ffffff",
      },
      borderRadius: {
        xl: "1rem",
        "2xl": "1.5rem",
      },
      boxShadow: {
        soft: "0 8px 20px rgba(0,0,0,0.08)",
        heavy: "0 12px 30px rgba(0,0,0,0.15)"
      },
      fontFamily: {
        fun: ["Comic Sans MS", "Poppins", "sans-serif"]
      }
    }
  }
};
</script>
</head>
<body class="min-h-screen bg-bgLight text-slate-800 font-fun">
<div class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-slate-900">
  <header class="border-b border-slate-800/70 backdrop-blur bg-slate-950/60 sticky top-0 z-10">

    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-primary flex items-center justify-center shadow-soft">
          <span class="text-xl">üñçÔ∏è</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-tight">Magic Story Colorbooks</h1>
          <p class="text-xs text-slate-400">
            Custom AI-made coloring storybooks from your idea
          </p>
        </div>
      </div>
      <button
        class="hidden sm:inline-flex text-xs px-3 py-1.5 rounded-full border border-slate-700 text-slate-300">
        Sign in (coming soon)
      </button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 lg:py-10 flex flex-col lg:flex-row gap-8">
    <!-- LEFT: Form -->
    <section class="w-full lg:w-[40%]">
      <div class="bg-white border border-blue-100 shadow-soft">
        <h2 class="text-xl font-semibold mb-1">Describe your book</h2>
        <p class="text-sm text-slate-400 mb-5">
          Example: ‚ÄúAn iguana named Sammy who‚Äôs afraid of the dark and learns to be brave at night.‚Äù
        </p>

        <form id="book-form" class="space-y-4">
          <div>
            <label class="text-xs font-medium text-slate-300 flex justify-between mb-1.5">
              <span>Working title</span>
              <span class="text-slate-500">Optional</span>
            </label>
            <input
              id="title"
              type="text"
              placeholder="Sammy the Brave Iguana"
              class="w-full text-sm px-3.5 py-2.5 rounded-xl bg-slate-900 border border-slate-700/80 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-slate-500" />
          </div>

          <div>
            <label class="text-xs font-medium text-slate-300 mb-1.5 block">
              Main character & details
            </label>
            <input
              id="main-character"
              type="text"
              placeholder="An iguana named Sammy who's afraid of the dark"
              class="w-full text-sm px-3.5 py-2.5 rounded-xl bg-slate-900 border border-slate-700/80 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-slate-500" />
          </div>

          <div>
            <label class="text-xs font-medium text-slate-300 mb-1.5 block">
              What should the story be about?
            </label>
            <textarea
              id="story-idea"
              rows="4"
              placeholder="Sammy hides under the covers at night until forest friends and glowing fireflies help him feel safe."
              class="w-full text-sm px-3.5 py-2.5 rounded-xl bg-slate-900 border border-slate-700/80 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary placeholder:text-slate-500 resize-none"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-300 mb-1.5 block">
                Age range
              </label>
              <select id="age-range"
                      class="w-full text-sm px-3.5 py-2.5 rounded-xl bg-slate-900 border border-slate-700/80 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                <option value="3-5">3‚Äì5 years</option>
                <option value="5-7">5‚Äì7 years</option>
                <option value="7-9">7‚Äì9 years</option>
              </select>
            </div>

            <div>
              <label class="text-xs font-medium text-slate-300 mb-1.5 block">
                Story length
              </label>
              <select id="page-count"
                      class="w-full text-sm px-3.5 py-2.5 rounded-xl bg-slate-900 border border-slate-700/80 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                <option value="8">8 pages</option>
                <option value="12">12 pages</option>
                <option value="16">16 pages</option>
              </select>
            </div>
          </div>

          <button
            id="generate-btn"
            type="submit"
            class="w-full mt-2 inline-flex items-center justify-center gap-2 text-sm font-medium rounded-xl px-4 py-2.5 bg-primary hover:bg-primaryDark transition shadow-soft disabled:opacity-60 disabled:cursor-not-allowed">
            <span id="generate-btn-label">‚ú® Generate Book</span>
            <span id="generate-btn-spinner" class="hidden text-xs animate-pulse">Thinking‚Ä¶</span>
          </button>
        </form>

        <button
          id="download-pdf-btn"
          class="w-full mt-3 inline-flex items-center justify-center gap-2 text-xs font-medium rounded-xl px-4 py-2 border border-slate-700 text-slate-200 hover:bg-slate-800/80 transition disabled:opacity-60 disabled:cursor-not-allowed"
          disabled>
          üìÑ Download PDF
        </button>

        <button
          id="generate-images-btn"
          class="w-full mt-2 inline-flex items-center justify-center gap-2 text-xs font-medium rounded-xl px-4 py-2 border border-slate-700 text-slate-200 hover:bg-slate-800/80 transition disabled:opacity-60 disabled:cursor-not-allowed"
          disabled>
          üé® Generate Coloring Pages
        </button>

        <p class="mt-4 text-[11px] text-slate-500">
          In production you'll add logins, payment, and save each book to a user‚Äôs library.
        </p>
      </div>
    </section>

    <!-- RIGHT: Output -->
    <section class="w-full lg:w-[60%]">
      <div class="bg-slate-900/80 rounded-2xl border border-slate-800 shadow-soft p-5 flex flex-col h-full">
        <!-- Status -->
        <div id="status-bar"
             class="mb-4 rounded-xl border border-slate-800 bg-slate-950/80 px-3.5 py-2.5 flex items-start gap-2 text-xs text-slate-300">
          <span id="status-icon">üí°</span>
          <div>
            <p id="status-title" class="font-medium">Ready to create a book.</p>
            <p id="status-text" class="text-slate-400 mt-0.5">
              Enter a character and story idea, then click ‚ÄúGenerate Book‚Äù.
            </p>
          </div>
        </div>

        <!-- Generated content -->
        <div id="output-container" class="flex-1 overflow-auto space-y-4 pr-1">
          <!-- Story -->
          <div id="story-card" class="hidden bg-slate-950/80 rounded-2xl border border-slate-800 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-500 mb-0.5">Story</p>
                <h3 id="story-title" class="text-lg font-semibold">Title</h3>
                <p id="story-tagline" class="text-xs text-slate-400 mt-1"></p>
              </div>
              <span class="text-[11px] rounded-full px-2.5 py-1 bg-slate-800/80 text-slate-300 border border-slate-700/80">
                AI generated
              </span>
            </div>
            <div id="story-body" class="space-y-3 text-sm leading-relaxed text-slate-200">
              <!-- paragraphs -->
            </div>
          </div>

          <!-- Coloring prompts -->
          <div id="prompts-card" class="hidden bg-slate-950/80 rounded-2xl border border-slate-800 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-500 mb-0.5">
                  Coloring pages
                </p>
                <h3 class="text-lg font-semibold">Page-by-page prompts</h3>
              </div>
              <span class="text-[11px] rounded-full px-2.5 py-1 bg-slate-800/80 text-slate-300 border border-slate-700/80">
                Line-art style
              </span>
            </div>
            <p class="text-xs text-slate-400 mb-2">
              Each prompt is written for a black-and-white, thick-outline coloring page.
            </p>
            <ol id="prompts-list" class="space-y-2 text-sm list-decimal list-inside text-slate-200">
              <!-- li items -->
            </ol>
          </div>

          <!-- Coloring images -->
          <div id="images-card" class="hidden bg-slate-950/80 rounded-2xl border border-slate-800 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-500 mb-0.5">
                  Coloring images
                </p>
                <h3 class="text-lg font-semibold">AI-generated pages</h3>
              </div>
              <span class="text-[11px] rounded-full px-2.5 py-1 bg-slate-800/80 text-slate-300 border border-slate-700/80">
                Preview only
              </span>
            </div>
            <p class="text-xs text-slate-400 mb-2">
              These previews are generated from the page prompts. You can right-click and save images to include in print layouts or KDP files.
            </p>
            <div id="images-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- images go here -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const form = document.getElementById("book-form");
  const generateBtn = document.getElementById("generate-btn");
  const generateBtnLabel = document.getElementById("generate-btn-label");
  const generateBtnSpinner = document.getElementById("generate-btn-spinner");
  const downloadBtn = document.getElementById("download-pdf-btn");
  const imagesBtn = document.getElementById("generate-images-btn");

  const statusIcon = document.getElementById("status-icon");
  const statusTitle = document.getElementById("status-title");
  const statusText = document.getElementById("status-text");

  const storyCard = document.getElementById("story-card");
  const storyTitleEl = document.getElementById("story-title");
  const storyTaglineEl = document.getElementById("story-tagline");
  const storyBodyEl = document.getElementById("story-body");

  const promptsCard = document.getElementById("prompts-card");
  const promptsList = document.getElementById("prompts-list");

  const imagesCard = document.getElementById("images-card");
  const imagesGrid = document.getElementById("images-grid");

  let lastBookData = null;

  function setLoading(isLoading, labelWhenReady = "‚ú® Generate Book") {
    generateBtn.disabled = isLoading;
    generateBtnSpinner.classList.toggle("hidden", !isLoading);
    generateBtnLabel.textContent = isLoading ? "Generating..." : labelWhenReady;
  }

  function setStatus({ icon, title, text }) {
    statusIcon.textContent = icon;
    statusTitle.textContent = title;
    statusText.textContent = text;
  }

  function renderBook(data) {
    const { title, tagline, paragraphs, prompts, ageRange } = data;

    storyTitleEl.textContent = title || "Your Custom Story";
    storyTaglineEl.textContent = tagline || (ageRange ? `For ages ${ageRange}` : "");
    storyBodyEl.innerHTML = "";
    (paragraphs || []).forEach(p => {
      const para = document.createElement("p");
      para.className = "text-slate-200";
      para.textContent = p;
      storyBodyEl.appendChild(para);
    });
    storyCard.classList.remove("hidden");

    promptsList.innerHTML = "";
    (prompts || []).forEach(item => {
      const li = document.createElement("li");
      li.className = "text-slate-200";
      li.innerHTML = `<span class="font-semibold">Page ${item.page}:</span> ${item.prompt}`;
      promptsList.appendChild(li);
    });
    if (prompts && prompts.length) {
      promptsCard.classList.remove("hidden");
    }

    setStatus({
      icon: "‚úÖ",
      title: "Book generated.",
      text: "You can review the story and prompts below and download a simple PDF. Later you can hook this into printing and payments."
    });

    lastBookData = data;
    downloadBtn.disabled = false;
    imagesBtn.disabled = !(prompts && prompts.length);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value;
    const mainCharacter = document.getElementById("main-character").value;
    const storyIdea = document.getElementById("story-idea").value;
    const ageRange = document.getElementById("age-range").value;
    const pageCount = document.getElementById("page-count").value;

    if (!mainCharacter.trim() && !storyIdea.trim()) {
      setStatus({
        icon: "‚ö†Ô∏è",
        title: "Tell the AI something to work with.",
        text: "Add a main character, a fear, or a situation you want the story to be about."
      });
      return;
    }

    setLoading(true);
    downloadBtn.disabled = true;
    imagesBtn.disabled = true;
    lastBookData = null;

    setStatus({
      icon: "‚ú®",
      title: "Generating your custom story coloring book‚Ä¶",
      text: "Talking to the AI to create a full story and page-by-page coloring prompts."
    });

    try {
      const res = await fetch("/api/generate-book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, mainCharacter, storyIdea, ageRange, pageCount })
      });

      if (!res.ok) {
        throw new Error("Request failed");
      }

      const data = await res.json();
      renderBook(data);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Something went wrong.",
        text: "Check your server logs or API key configuration, then try again."
      });
    } finally {
      setLoading(false);
    }
  });

  function renderImages(images) {
    imagesGrid.innerHTML = "";
    images.forEach((img) => {
      const wrapper = document.createElement("figure");
      wrapper.className = "border border-slate-800 rounded-xl overflow-hidden bg-slate-900";

      const imageEl = document.createElement("img");
      imageEl.src = img.url;
      imageEl.alt = `Coloring page ${img.page}`;
      imageEl.className = "w-full h-auto block";

      const caption = document.createElement("figcaption");
      caption.className = "text-xs text-slate-400 px-3 py-2";
      caption.textContent = `Page ${img.page}`;

      wrapper.appendChild(imageEl);
      wrapper.appendChild(caption);
      imagesGrid.appendChild(wrapper);
    });

    imagesCard.classList.remove("hidden");

    setStatus({
      icon: "üñçÔ∏è",
      title: "Coloring pages generated.",
      text: "These are AI image previews based on your page prompts. You can save them and use them in your print-ready layout."
    });
  }

  downloadBtn.addEventListener("click", async () => {
    if (!lastBookData) return;

    try {
      const res = await fetch("/api/export-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastBookData)
      });

      if (!res.ok) throw new Error("PDF request failed");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = (lastBookData.title || "custom-story") + ".pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "PDF download failed.",
        text: "Check the server console for errors in /api/export-pdf."
      });
    }
  });

  imagesBtn.addEventListener("click", async () => {
    if (!lastBookData || !lastBookData.prompts || !lastBookData.prompts.length) return;

    imagesBtn.disabled = true;
    setStatus({
      icon: "‚ú®",
      title: "Generating coloring page images‚Ä¶",
      text: "Asking the image model to create line-art pages from your prompts. This may take a little longer than text."
    });

    try {
      const res = await fetch("/api/generate-images", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompts: lastBookData.prompts })
      });

      if (!res.ok) throw new Error("Image request failed");

      const data = await res.json();
      renderImages(data.images || []);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Image generation failed.",
        text: "Check the server logs for /api/generate-images. Make sure your OPENAI_API_KEY works for images."
      });
    } finally {
      imagesBtn.disabled = false;
    }
  });
</script>
</body>
</html>
