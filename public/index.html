<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Story Colorbooks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4DA3FF",
            primaryDark: "#1E88E5",
            accentYellow: "#FFC94A",
            accentRed: "#FF6B6B",
            accentGreen: "#6BCB77",
            accentPurple: "#A97FFF",
            bgLight: "#FFF9EB",
            wood: "#D8A25E",
            woodDark: "#B17839"
          },
          borderRadius: {
            xl: "1rem",
            "2xl": "1.5rem",
          },
          boxShadow: {
            soft: "0 8px 20px rgba(15,23,42,0.08)",
            heavy: "0 18px 40px rgba(15,23,42,0.18)"
          },
          fontFamily: {
            fun: ["\"Comic Sans MS\"", "Poppins", "system-ui", "sans-serif"]
          }
        }
      }
    };
  </script>
</head>
<body class="min-h-screen bg-bgLight text-slate-800 font-fun">
<div class="min-h-screen">
  <!-- HEADER -->
  <header class="border-b border-wood/40 bg-white shadow-soft">
    <div class="max-w-5xl mx-auto px-4 pt-4 pb-2 flex items-center gap-4">
      <!-- Scribbles mascot -->
      <div class="relative flex items-center">
        <div class="w-14 h-14 rounded-2xl bg-amber-200 border-4 border-amber-300 overflow-hidden shadow-soft flex items-center justify-center">
          <img
            src="/Scribbles.png"
            alt="Scribbles the Crayon"
            class="w-full h-full object-cover"
          />
        </div>
      </div>
      <div class="flex-1">
        <h1 class="text-2xl font-bold tracking-tight text-amber-900">
          Magic Story Colorbooks
        </h1>
        <p class="text-xs text-amber-800/80">
          Help your child‚Äôs imagination and reading grow with custom story coloring books.
        </p>
      </div>
      <div class="hidden md:flex flex-col items-end gap-1 text-[11px]">
        <span class="text-amber-900 font-semibold">Grown-up area</span>
        <button class="px-3 py-1 rounded-full border border-amber-300 text-[11px] text-amber-900 bg-amber-100 hover:bg-amber-200 shadow-soft">
          Parent dashboard (coming soon)
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="max-w-5xl mx-auto px-4 pb-3">
      <div class="flex flex-wrap gap-2 text-xs font-semibold">
        <button class="px-4 py-1.5 rounded-full bg-primary text-white shadow-soft">
          Home
        </button>
        <button class="px-4 py-1.5 rounded-full bg-accentRed text-white shadow-soft">
          Get reading
        </button>
        <button class="px-4 py-1.5 rounded-full bg-accentYellow text-amber-900 shadow-soft">
          Make a book
        </button>
        <button class="px-4 py-1.5 rounded-full bg-accentGreen text-white shadow-soft">
          Fun ideas
        </button>
        <button class="px-4 py-1.5 rounded-full bg-accentPurple text-white shadow-soft">
          My shelf
        </button>
      </div>
    </nav>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 lg:py-8 flex flex-col lg:flex-row gap-8">
    <!-- LEFT: FORM -->
    <section class="w-full lg:w-[40%]">
      <div class="bg-white rounded-2xl border border-amber-200 shadow-heavy p-5 relative overflow-hidden">
        <div class="pointer-events-none absolute -top-10 -right-8 w-32 h-32 rounded-full bg-[#FEF3C7]/80 blur-xl"></div>
        <div class="pointer-events-none absolute -bottom-10 -left-10 w-32 h-32 rounded-full bg-[#DBEAFE]/80 blur-xl"></div>

        <div class="relative space-y-4">
          <!-- Scribbles intro bubble -->
          <div class="bg-white rounded-2xl border border-amber-200 shadow-soft p-3 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center border border-amber-200 overflow-hidden">
              <img
                src="/Scribbles.png"
                alt="Scribbles the Crayon"
                class="w-full h-full object-cover"
              />
            </div>
            <div class="text-xs">
              <p class="font-semibold text-amber-900">Hi, I‚Äôm Scribbles!</p>
              <p class="text-amber-800/80">
                Tell me about your character and I‚Äôll help you make a story coloring book for the shelf.
              </p>
            </div>
          </div>

          <h2 class="text-xl font-bold mb-1 flex items-center gap-2 text-amber-900">
            ‚úèÔ∏è Describe your book
          </h2>
          <p class="text-sm text-amber-800/80 mb-2">
            Example: ‚ÄúAn iguana named Sammy who‚Äôs afraid of the dark and learns to be brave at night.‚Äù
          </p>

          <form id="book-form" class="space-y-4">
            <div>
              <label class="text-xs font-semibold text-amber-900 flex justify-between mb-1.5">
                <span>Book title</span>
                <span class="text-amber-700/70">Optional</span>
              </label>
              <input
                id="title"
                type="text"
                placeholder="Sammy the Brave Iguana"
                class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#FFFBEB] border border-amber-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30 placeholder:text-amber-600/80" />
            </div>

            <div>
              <label class="text-xs font-semibold text-amber-900 mb-1.5 block">
                üñçÔ∏è Main character
              </label>
              <input
                id="main-character"
                type="text"
                placeholder="An iguana named Sammy who's afraid of the dark"
                class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#FFFBEB] border border-amber-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30 placeholder:text-amber-600/80" />
            </div>

            <div>
              <label class="text-xs font-semibold text-amber-900 mb-1.5 block">
                üåü What should the story be about?
              </label>
              <textarea
                id="story-idea"
                rows="4"
                placeholder="Sammy hides under the covers at night until forest friends and glowing fireflies help him feel safe."
                class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#FFFBEB] border border-amber-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30 placeholder:text-amber-600/80 resize-none"></textarea>
              <p class="mt-1 text-[11px] text-amber-800/80">
                The app turns this into a cosy kids‚Äô story with matching coloring pages.
              </p>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-semibold text-amber-900 mb-1.5 block">
                  üéÇ Age range
                </label>
                <select id="age-range"
                        class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#FFFBEB] border border-amber-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30">
                  <option value="3-5">3‚Äì5 years</option>
                  <option value="5-7">5‚Äì7 years</option>
                  <option value="7-9">7‚Äì9 years</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-semibold text-amber-900 mb-1.5 block">
                  üìñ Story length
                </label>
                <select id="page-count"
                        class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#FFFBEB] border border-amber-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30">
                  <option value="8">8 pages</option>
                  <option value="12">12 pages</option>
                  <option value="16">16 pages</option>
                </select>
              </div>
            </div>

            <button
              id="generate-btn"
              type="submit"
              class="w-full mt-2 inline-flex items-center justify-center gap-2 text-sm font-semibold rounded-2xl px-5 py-3 bg-primary text-white shadow-soft hover:bg-primaryDark transition disabled:opacity-60 disabled:cursor-not-allowed">
              <span id="generate-btn-label">‚ú® Generate Book</span>
              <span id="generate-btn-spinner" class="hidden text-xs animate-pulse">Thinking‚Ä¶</span>
            </button>
          </form>

          <button
            id="download-pdf-btn"
            class="w-full mt-3 inline-flex items-center justify-center gap-2 text-xs font-semibold rounded-2xl px-4 py-2 bg-white border border-amber-300 text-amber-900 hover:bg-amber-50 transition disabled:opacity-60 disabled:cursor-not-allowed"
            disabled>
            üìÑ Download PDF
          </button>

          <button
            id="generate-images-btn"
            class="w-full mt-2 inline-flex items-center justify-center gap-2 text-xs font-semibold rounded-2xl px-4 py-2 bg-white border border-amber-300 text-amber-900 hover:bg-amber-50 transition disabled:opacity-60 disabled:cursor-not-allowed"
            disabled>
            üé® Generate Coloring Pages
          </button>

          <p class="mt-2 text-[11px] text-amber-800/80">
            Later you can add accounts, payments, and a saved ‚Äúbook shelf‚Äù for each child.
          </p>
        </div>
      </div>
    </section>

    <!-- RIGHT: STATUS + SHELVES -->
    <section class="w-full lg:w-[60%] space-y-4">
      <!-- Status -->
      <div id="status-bar"
           class="rounded-2xl border border-amber-200 bg-[#FFFBEB] px-3.5 py-3 flex items-start gap-2 text-xs text-amber-900 shadow-soft">
        <span id="status-icon" class="text-lg">üí°</span>
        <div>
          <p id="status-title" class="font-semibold">Ready to create a book.</p>
          <p id="status-text" class="text-amber-800/90 mt-0.5">
            Enter a character and story idea, then click ‚ÄúGenerate Book‚Äù.
          </p>
        </div>
      </div>

      <!-- Shelf area -->
      <div class="bg-transparent flex-1 flex flex-col gap-6">
        <!-- Top shelf: story -->
        <div class="relative pb-6">
          <div class="absolute left-0 right-0 bottom-0 h-4 bg-wood border-t border-woodDark shadow-inner"></div>

          <div class="flex gap-4 px-2 pb-3">
            <div id="story-card"
                 class="hidden bg-white rounded-xl border-2 border-amber-300 shadow-heavy p-4 w-full max-w-sm">
              <div class="flex items-center justify-between gap-3 mb-2">
                <div>
                  <p class="text-[11px] uppercase tracking-[0.12em] text-amber-700 mb-0.5 flex items-center gap-1">
                    <span>Story book</span> <span>üìñ</span>
                  </p>
                  <h3 id="story-title" class="text-lg font-bold text-amber-900">Title</h3>
                  <p id="story-tagline" class="text-xs text-amber-800 mt-1"></p>
                </div>
                <span class="text-[11px] rounded-full px-2.5 py-1 bg-blue-50 text-blue-700 border border-blue-200">
                  AI made
                </span>
              </div>
              <div id="story-body" class="space-y-3 text-sm leading-relaxed text-amber-900">
                <!-- paragraphs -->
              </div>
            </div>
          </div>
        </div>

        <!-- Middle shelf: prompts -->
        <div class="relative pb-6">
          <div class="absolute left-0 right-0 bottom-0 h-4 bg-wood border-t border-woodDark shadow-inner"></div>

          <div class="flex gap-4 px-2 pb-3">
            <div id="prompts-card"
                 class="hidden bg-white rounded-xl border-2 border-amber-300 p-4 w-full">
              <div class="flex items-center justify-between gap-3 mb-2">
                <div>
                  <p class="text-[11px] uppercase tracking-[0.12em] text-amber-700 mb-0.5 flex items-center gap-1">
                    <span>Coloring page ideas</span> <span>üñçÔ∏è</span>
                  </p>
                  <h3 class="text-lg font-bold text-amber-900">Page-by-page prompts</h3>
                </div>
                <span class="text-[11px] rounded-full px-2.5 py-1 bg-amber-50 text-amber-900 border border-amber-200">
                  Line-art style
                </span>
              </div>
              <p class="text-xs text-amber-800/90 mb-2">
                Each prompt is written for a black-and-white, thick-outline coloring page.
              </p>
              <ol id="prompts-list" class="space-y-2 text-sm list-decimal list-inside text-amber-900">
                <!-- li items -->
              </ol>
            </div>
          </div>
        </div>

        <!-- Bottom shelf: images -->
        <div class="relative pb-6">
          <div class="absolute left-0 right-0 bottom-0 h-4 bg-wood border-t border-woodDark shadow-inner"></div>

          <div class="flex gap-4 px-2 pb-3">
            <div id="images-card"
                 class="hidden bg-white rounded-xl border-2 border-amber-300 p-4 w-full">
              <div class="flex items-center justify-between gap-3 mb-2">
                <div>
                  <p class="text-[11px] uppercase tracking-[0.12em] text-amber-700 mb-0.5 flex items-center gap-1">
                    <span>Coloring images</span> <span>üé®</span>
                  </p>
                  <h3 class="text-lg font-bold text-amber-900">AI-generated pages</h3>
                </div>
                <span class="text-[11px] rounded-full px-2.5 py-1 bg-pink-50 text-pink-700 border border-pink-200">
                  Preview only
                </span>
              </div>
              <p class="text-xs text-amber-800/90 mb-2">
                These previews come from your prompts. You can save them and use them in a print layout.
              </p>
              <div id="images-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- images go here -->
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>
</div>

<script>
  const form = document.getElementById("book-form");
  const generateBtn = document.getElementById("generate-btn");
  const generateBtnLabel = document.getElementById("generate-btn-label");
  const generateBtnSpinner = document.getElementById("generate-btn-spinner");
  const downloadBtn = document.getElementById("download-pdf-btn");
  const imagesBtn = document.getElementById("generate-images-btn");

  const statusIcon = document.getElementById("status-icon");
  const statusTitle = document.getElementById("status-title");
  const statusText = document.getElementById("status-text");

  const storyCard = document.getElementById("story-card");
  const storyTitleEl = document.getElementById("story-title");
  const storyTaglineEl = document.getElementById("story-tagline");
  const storyBodyEl = document.getElementById("story-body");

  const promptsCard = document.getElementById("prompts-card");
  const promptsList = document.getElementById("prompts-list");

  const imagesCard = document.getElementById("images-card");
  const imagesGrid = document.getElementById("images-grid");

  let lastBookData = null;

  function setLoading(isLoading, labelWhenReady = "‚ú® Generate Book") {
    generateBtn.disabled = isLoading;
    generateBtnSpinner.classList.toggle("hidden", !isLoading);
    generateBtnLabel.textContent = isLoading ? "Generating..." : labelWhenReady;
  }

  function setStatus({ icon, title, text }) {
    statusIcon.textContent = icon;
    statusTitle.textContent = title;
    statusText.textContent = text;
  }

  function renderBook(data) {
    const { title, tagline, paragraphs, prompts, ageRange } = data;

    storyTitleEl.textContent = title || "Your Custom Story";
    storyTaglineEl.textContent = tagline || (ageRange ? `For ages ${ageRange}` : "");
    storyBodyEl.innerHTML = "";
    (paragraphs || []).forEach(p => {
      const para = document.createElement("p");
      para.className = "text-amber-900";
      para.textContent = p;
      storyBodyEl.appendChild(para);
    });
    storyCard.classList.remove("hidden");

    promptsList.innerHTML = "";
    (prompts || []).forEach(item => {
      const li = document.createElement("li");
      li.className = "text-amber-900";
      li.innerHTML = `<span class="font-semibold">Page ${item.page}:</span> ${item.prompt}`;
      promptsList.appendChild(li);
    });
    if (prompts && prompts.length) {
      promptsCard.classList.remove("hidden");
    }

    setStatus({
      icon: "‚úÖ",
      title: "Book generated.",
      text: "Your story is sitting on the shelf! Check the story and coloring prompts below."
    });

    lastBookData = data;
    downloadBtn.disabled = false;
    imagesBtn.disabled = !(prompts && prompts.length);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value;
    const mainCharacter = document.getElementById("main-character").value;
    const storyIdea = document.getElementById("story-idea").value;
    const ageRange = document.getElementById("age-range").value;
    const pageCount = document.getElementById("page-count").value;

    if (!mainCharacter.trim() && !storyIdea.trim()) {
      setStatus({
        icon: "‚ö†Ô∏è",
        title: "Tell Scribbles a bit more!",
        text: "Add a main character, a feeling, or a problem you want the story to be about."
      });
      return;
    }

    setLoading(true);
    downloadBtn.disabled = true;
    imagesBtn.disabled = true;
    lastBookData = null;

    setStatus({
      icon: "‚ú®",
      title: "Scribbles is writing your magic story‚Ä¶",
      text: "Scribbles is writing a cosy story with page-by-page coloring prompts."
    });

    try {
      const res = await fetch("/api/generate-book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, mainCharacter, storyIdea, ageRange, pageCount })
      });

      if (!res.ok) {
        throw new Error("Request failed");
      }

      const data = await res.json();
      renderBook(data);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Something went wrong.",
        text: "Check your server logs or API key configuration, then try again."
      });
    } finally {
      setLoading(false);
    }
  });

  function renderImages(images) {
    imagesGrid.innerHTML = "";
    images.forEach((img) => {
      const wrapper = document.createElement("figure");
      wrapper.className = "border border-amber-200 rounded-xl overflow-hidden bg-[#FFFBEB]";

      const imageEl = document.createElement("img");
      imageEl.src = img.url;
      imageEl.alt = `Coloring page ${img.page}`;
      imageEl.className = "w-full h-auto block";

      const caption = document.createElement("figcaption");
      caption.className = "text-xs text-amber-800 px-3 py-2";
      caption.textContent = `Page ${img.page}`;

      wrapper.appendChild(imageEl);
      wrapper.appendChild(caption);
      imagesGrid.appendChild(wrapper);
    });

    imagesCard.classList.remove("hidden");

    setStatus({
      icon: "üñçÔ∏è",
      title: "Coloring pages ready.",
      text: "Your coloring pages are now sitting on the bottom shelf. You can save them for printing."
    });
  }

  downloadBtn.addEventListener("click", async () => {
    if (!lastBookData) return;

    try {
      const res = await fetch("/api/export-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastBookData)
      });

      if (!res.ok) throw new Error("PDF request failed");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = (lastBookData.title || "custom-story") + ".pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "PDF download failed.",
        text: "Check the server console for errors in /api/export-pdf."
      });
    }
  });

  imagesBtn.addEventListener("click", async () => {
    if (!lastBookData || !lastBookData.prompts || !lastBookData.prompts.length) return;

    imagesBtn.disabled = true;
    setStatus({
      icon: "‚ú®",
      title: "Making coloring pages‚Ä¶",
      text: "Using your prompts to create coloring page previews for the bottom shelf."
    });

    try {
      const res = await fetch("/api/generate-images", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompts: lastBookData.prompts })
      });

      if (!res.ok) throw new Error("Image request failed");

      const data = await res.json();
      renderImages(data.images || []);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Image generation failed.",
        text: "Check the server logs for /api/generate-images."
      });
    } finally {
      imagesBtn.disabled = false;
    }
  });
</script>
</body>
</html>
